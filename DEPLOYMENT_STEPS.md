# 🚀 デプロイ手順書

## ✅ 実装完了した機能

### 1. ユーザー管理機能
- ✅ ユーザー情報の保存・取得
- ✅ 利用回数の管理
- ✅ 会話状態の管理
- ✅ 占い履歴の保存

### 2. 利用制限機能
- ✅ プラン別の回数制限
- ✅ 無料ユーザー：初回1回のみ
- ✅ 有料ユーザー：プラン別制限
- ✅ 制限超過時のメッセージ

### 3. ルカの会話機能
- ✅ 3往復までの会話
- ✅ OpenAI GPT-4.1-miniによる応答生成
- ✅ ユーザーの悩みを把握
- ✅ メニュー誘導

### 4. 料金プラン管理
- ✅ 5つのプラン（無料、単品、ライト、スタンダード、プレミアム）
- ✅ プラン別の機能制限
- ✅ ルカ使用権限の管理

---

## 📝 デプロイ前の確認

### ✅ テスト結果
```
🧪 機能テスト開始
【テスト1】ユーザー作成 ✅
【テスト2】初回ユーザーチェック ✅
【テスト3】使用可能チェック（無料プラン） ✅
【テスト4】占い実行後の処理 ✅
【テスト5】2回目の使用チェック（制限） ✅
【テスト6】プラン変更（ライト会員） ✅
【テスト7】ルカ使用チェック ✅
【テスト8】会話状態の管理 ✅
【テスト9】占い履歴の追加 ✅
【テスト10】全プラン情報 ✅
🎉 全テスト完了！
```

### ✅ 構文チェック
```
✅ database.js - OK
✅ usage-limiter.js - OK
✅ luka-conversation.js - OK
✅ index-new.js - OK
```

---

## 🚀 デプロイ手順

### ステップ1: 既存のindex.jsをバックアップ

```bash
cd /home/ubuntu/tarot-linebot
cp index.js index-backup-$(date +%Y%m%d).js
```

### ステップ2: 新しいindex.jsに置き換え

```bash
mv index-new.js index.js
```

### ステップ3: GitHubにプッシュ

```bash
git add .
git commit -m "feat: ユーザー管理・会話機能・利用制限を実装

- ユーザー管理機能（database.js）
- 利用制限機能（usage-limiter.js）
- ルカの会話機能（luka-conversation.js）
- 料金プラン管理
- 初回ユーザー挨拶
- マイページ機能
- 占い履歴保存

全テスト完了 ✅"

git push origin main
```

### ステップ4: Renderでデプロイ確認

1. https://dashboard.render.com にアクセス
2. tarot-linebot のサービスを選択
3. 「Logs」タブでデプロイ状況を確認
4. エラーがないか確認

### ステップ5: LINEボットでテスト

**テスト項目：**

1. **初回ユーザー挨拶**
   - 新しいユーザーでボットを友達追加
   - 「初めまして〇〇さん💕」が表示されるか確認

2. **無料占い**
   - リッチメニューから「タロット占い」をタップ
   - 3カード占いが実行されるか確認
   - 2回目は制限メッセージが表示されるか確認

3. **ルカ占い（無料ユーザー）**
   - リッチメニューから「ルカ占い」をタップ
   - 「有料会員限定」メッセージが表示されるか確認

4. **マイページ**
   - リッチメニューから「マイページ」をタップ
   - プラン情報、残り回数が表示されるか確認

5. **決済**
   - リッチメニューから「決済」をタップ
   - 料金プラン一覧が表示されるか確認

---

## 🔧 トラブルシューティング

### エラー: users.jsonが見つからない
**原因:** 初回起動時にファイルが作成されていない  
**解決:** 自動的に作成されるので問題なし

### エラー: OpenAI API error
**原因:** OPENAI_API_KEYが設定されていない  
**解決:** Renderの環境変数を確認

### エラー: Cannot read property 'conversationState'
**原因:** ユーザーデータの構造が古い  
**解決:** users.jsonを削除して再起動

---

## 📊 デプロイ後の確認事項

- [ ] ボットが正常に起動している
- [ ] 初回ユーザー挨拶が表示される
- [ ] 無料占いが1回使える
- [ ] 2回目は制限メッセージが表示される
- [ ] マイページが正しく表示される
- [ ] 決済ページが表示される

---

## 🎯 次のステップ

### 1. Stripe決済機能の実装
- 単品購入（380円）
- 月額サブスクリプション
- Webhookの設定

### 2. 自動更新通知機能
- 1週間前通知
- 朝10時送信
- 解約案内

### 3. 会話内容の占い反映
- ユーザーの悩みを分析
- 占い結果に反映

### 4. MongoDB移行
- スケーラビリティ向上
- バックアップ機能

---

## 📞 サポート

質問があれば、いつでも聞いてください！😊✨

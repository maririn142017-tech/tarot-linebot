<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - ãƒ«ã‚«ã®ã‚¿ãƒ­ãƒƒãƒˆå ã„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 24px;
      color: #333;
      margin-bottom: 10px;
    }

    .user-name {
      font-size: 20px;
      color: #667eea;
      font-weight: bold;
    }

    .section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .plan-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .plan-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .plan-detail {
      font-size: 14px;
      opacity: 0.9;
    }

    .usage-info {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: #f8f9ff;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .usage-label {
      font-size: 14px;
      color: #666;
    }

    .usage-value {
      font-size: 16px;
      font-weight: bold;
      color: #667eea;
    }

    .history-item {
      padding: 12px;
      background: #f8f9ff;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-left {
      flex: 1;
    }

    .history-date {
      font-size: 12px;
      color: #999;
      margin-bottom: 3px;
    }

    .history-type {
      font-size: 15px;
      color: #333;
      font-weight: bold;
    }

    .history-theme {
      font-size: 13px;
      color: #666;
    }

    .history-icon {
      font-size: 24px;
    }

    .loading {
      text-align: center;
      color: white;
      padding: 40px;
      font-size: 18px;
    }

    .empty-message {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 14px;
    }

    .footer {
      text-align: center;
      color: white;
      margin-top: 20px;
      padding: 15px;
      opacity: 0.8;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div id="content" style="display: none;">
      <div class="header">
        <h1>ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        <div class="user-name" id="user-name"></div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ‘‘ ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</div>
        <div class="plan-info">
          <div class="plan-name" id="plan-name"></div>
          <div class="plan-detail" id="plan-detail"></div>
        </div>
      </div>

      <div class="section" id="usage-section">
        <div class="section-title">ğŸ“ˆ åˆ©ç”¨çŠ¶æ³</div>
        <div id="usage-info"></div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ“œ æœ€è¿‘ã®å ã„</div>
        <div id="history-list"></div>
      </div>

      <div class="footer">
        âœ¨ ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ’•
      </div>
    </div>
  </div>

  <script>
    let userId = null;

    // LIFFåˆæœŸåŒ–
    window.onload = function() {
      liff.init({
        liffId: 'YOUR_LIFF_ID' // å¾Œã§è¨­å®š
      }).then(() => {
        if (liff.isLoggedIn()) {
          liff.getProfile().then(profile => {
            userId = profile.userId;
            loadUserData();
          }).catch(err => {
            console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            document.getElementById('loading').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          });
        } else {
          liff.login();
        }
      }).catch((err) => {
        console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
        document.getElementById('loading').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      });
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadUserData() {
      try {
        const response = await fetch(`/api/user-data?userId=${userId}`);
        const data = await response.json();
        
        displayUserData(data);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    function displayUserData(data) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
      document.getElementById('user-name').textContent = `${data.displayName}ã•ã‚“`;
      
      // ãƒ—ãƒ©ãƒ³æƒ…å ±
      const planInfo = getPlanInfo(data.plan);
      document.getElementById('plan-name').textContent = planInfo.name;
      document.getElementById('plan-detail').textContent = planInfo.detail;
      
      // åˆ©ç”¨çŠ¶æ³
      const usageInfo = document.getElementById('usage-info');
      if (data.plan === 'free') {
        usageInfo.innerHTML = `
          <div class="usage-info">
            <span class="usage-label">ç„¡æ–™å ã„</span>
            <span class="usage-value">${data.freeReadingUsed ? 'ä½¿ç”¨æ¸ˆã¿' : 'æœªä½¿ç”¨'}</span>
          </div>
        `;
      } else if (data.plan === 'single') {
        // å˜å“è³¼å…¥ã®å ´åˆ
        usageInfo.innerHTML = `
          <div class="usage-info">
            <span class="usage-label">ä»Šæ—¥ã®æ®‹ã‚Šå›æ•°</span>
            <span class="usage-value">éƒ½åº¦è³¼å…¥</span>
          </div>
          <div class="usage-info">
            <span class="usage-label">ä»Šæ—¥ã®åˆ©ç”¨å›æ•°</span>
            <span class="usage-value">${data.usageCount.today}å›</span>
          </div>
        `;
      } else {
        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ©ã‚¤ãƒˆãƒ»ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼‰ã®å ´åˆ
        // ãƒ—ãƒ©ãƒ³å¤‰æ›´å¾Œã®ä½¿ç”¨å›æ•°ã‚’ä½¿ç”¨
        const usedCount = data.usageCountAfterPlanChange !== undefined ? data.usageCountAfterPlanChange : data.usageCount.today;
        const remaining = Math.max(0, planInfo.dailyLimit - usedCount); // ãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«
        usageInfo.innerHTML = `
          <div class="usage-info">
            <span class="usage-label">ä»Šæ—¥ã®æ®‹ã‚Šå›æ•°</span>
            <span class="usage-value">${remaining}å›</span>
          </div>
          <div class="usage-info">
            <span class="usage-label">ä»Šæ—¥ã®åˆ©ç”¨å›æ•°</span>
            <span class="usage-value">${data.usageCount.today}å›</span>
          </div>
        `;
      }
      
      // å ã„å±¥æ­´
      const historyList = document.getElementById('history-list');
      if (data.readingHistory && data.readingHistory.length > 0) {
        historyList.innerHTML = '';
        data.readingHistory.slice(0, 10).forEach(reading => {
          const item = createHistoryItem(reading);
          historyList.appendChild(item);
        });
      } else {
        historyList.innerHTML = '<div class="empty-message">ã¾ã å ã„ã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
    }

    // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
    function getPlanInfo(plan) {
      const plans = {
        free: {
          name: 'ç„¡æ–™ãƒ—ãƒ©ãƒ³',
          detail: 'åˆå›1å›ã®ã¿ç„¡æ–™ã§å ãˆã¾ã™',
          dailyLimit: 0
        },
        single: {
          name: 'å˜å“è³¼å…¥',
          detail: '380å††/å›ã§ä½•å›ã§ã‚‚å ãˆã¾ã™',
          dailyLimit: 999
        },
        light: {
          name: 'ãƒ©ã‚¤ãƒˆä¼šå“¡',
          detail: '3,000å††/æœˆ - 1æ—¥1å›',
          dailyLimit: 1
        },
        standard: {
          name: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ä¼šå“¡',
          detail: '5,000å††/æœˆ - 1æ—¥2å›',
          dailyLimit: 2
        },
        premium: {
          name: 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡',
          detail: '9,800å††/3ãƒ¶æœˆ - 1æ—¥2å›',
          dailyLimit: 2
        }
      };
      return plans[plan] || plans.free;
    }

    // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    function createHistoryItem(reading) {
      const div = document.createElement('div');
      div.className = 'history-item';
      
      const date = new Date(reading.timestamp).toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      
      const type = reading.type === 'love' ? 'æ‹æ„›å ã„' : 'ä¸€èˆ¬å ã„';
      const icon = reading.type === 'love' ? 'ğŸ’•' : 'ğŸ”®';
      const theme = reading.theme ? `ï¼ˆ${reading.theme}ï¼‰` : '';
      
      div.innerHTML = `
        <div class="history-left">
          <div class="history-date">${date}</div>
          <div class="history-type">${type}</div>
          <div class="history-theme">${theme}</div>
        </div>
        <div class="history-icon">${icon}</div>
      `;
      
      return div;
    }
  </script>
</body>
</html>

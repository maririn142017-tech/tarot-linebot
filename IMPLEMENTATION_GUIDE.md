# 実装ガイド - ユーザー管理・会話機能・利用制限

## 📋 実装した機能

### 1. ユーザー管理機能（database.js）

**主な機能：**
- ユーザー情報の保存・取得
- 利用回数の管理
- 会話状態の管理
- 占い履歴の保存
- サブスクリプション情報の管理

**データ構造：**
```javascript
{
  userId: "U1234567890...",
  displayName: "ユーザー名",
  plan: "free", // free, single, light, standard, premium
  createdAt: "2025-12-22T...",
  lastUsedAt: "2025-12-22T...",
  freeReadingUsed: false,
  usageCount: {
    today: 0,
    lastResetDate: "2025-12-22"
  },
  conversationState: {
    isInConversation: false,
    conversationCount: 0,
    conversationHistory: [],
    userQuestion: ""
  },
  subscription: {
    startDate: null,
    endDate: null,
    autoRenew: false,
    notificationSent: false
  },
  readingHistory: []
}
```

---

### 2. 利用制限機能（usage-limiter.js）

**プラン別制限：**

| プラン | 料金 | 1日の制限 | ルカ | 備考 |
|--------|------|-----------|------|------|
| 無料 | 0円 | 初回1回のみ | ❌ | 登録時のみ |
| 単品 | 380円/回 | 無制限 | ✅ | 購入ごと |
| ライト | 3,000円/月 | 1回 | ✅ | 月額 |
| スタンダード | 5,000円/月 | 2回 | ✅ | 月額 |
| プレミアム | 9,800円/3ヶ月 | 2回 | ✅ | 3ヶ月 |

**主な機能：**
- 使用可能回数のチェック
- プラン別の制限メッセージ生成
- ルカ使用権限のチェック
- 初回ユーザーの判定

---

### 3. ルカの会話機能（luka-conversation.js）

**会話フロー（最大3往復）：**

**1往復目：**
```
ルカ：「〇〇さん、こんにちは🌈今日はどんな事を占いたい❓🔮」
ユーザー：「彼氏のことで悩んでて...」
ルカ：「彼氏のことで悩んでるんだね😊
      ルカが占うから下のメニューから選んでね✨」
```

**2往復目：**
```
ユーザー：「最近連絡が少なくて...」
ルカ：「うんうん、わかったよ😊
      占うには下のメニューから選んでね🎶」
```

**3往復目以降：**
```
ルカ：「メニューから選んでね✨」（固定）
```

**特徴：**
- OpenAI GPT-4.1-miniを使用
- ユーザーの悩みを把握してオウム返し
- 会話内容を占い結果に反映（将来実装予定）
- エラー時のフォールバック機能

---

### 4. 新しいindex.js（index-new.js）

**実装した機能：**

#### ✅ 初回ユーザー挨拶
```
初めまして〇〇さん💕
ルカに会いに来てくれてありがとう✨
...
```

#### ✅ リッチメニュー対応
- タロット占い
- ルカ占い（会話機能付き）
- 恋愛占い
- カード解釈集
- マイページ
- 決済（準備中）

#### ✅ 利用制限チェック
- プラン別の回数制限
- 無料ユーザーは初回1回のみ
- 制限超過時のメッセージ表示

#### ✅ 会話機能
- ルカ占い選択時に会話開始
- 3往復まで会話可能
- 会話後にメニュー誘導

#### ✅ 占い履歴
- マイページで確認可能
- 最新50件まで保存

---

## 🚀 デプロイ手順

### 1. 既存のindex.jsをバックアップ
```bash
cd /home/ubuntu/tarot-linebot
mv index.js index-old.js
mv index-new.js index.js
```

### 2. GitHubにプッシュ
```bash
git add .
git commit -m "ユーザー管理・会話機能・利用制限を実装"
git push origin main
```

### 3. Renderで自動デプロイ
- GitHubにプッシュすると自動的にRenderがデプロイ
- ログを確認してエラーがないかチェック

---

## 🧪 テスト項目

### 基本機能
- [ ] 初回ユーザーの挨拶が表示される
- [ ] 無料占いが1回使える
- [ ] 2回目は制限メッセージが表示される

### ルカ占い
- [ ] 無料ユーザーは「有料限定」メッセージが表示される
- [ ] 有料ユーザーは会話が開始される
- [ ] 3往復まで会話できる
- [ ] 4往復目は「メニューから選んでね」が表示される

### マイページ
- [ ] 現在のプランが表示される
- [ ] 今日の残り回数が表示される
- [ ] 占い履歴が表示される

---

## 📝 今後の実装予定

### 1. Stripe決済機能
- 単品購入（380円）
- 月額サブスクリプション
- 3ヶ月プレミアム

### 2. 自動更新通知
- 1週間前に通知
- 朝10時に送信
- 解約方法の案内

### 3. 会話内容の占い反映
- ユーザーの悩みを分析
- 占い結果に反映
- よりパーソナライズされたメッセージ

### 4. MongoDB移行
- JSONファイルからMongoDBへ
- スケーラビリティ向上
- バックアップ機能

---

## 🔧 トラブルシューティング

### users.jsonが見つからない
→ 自動的に作成されます

### OpenAI APIエラー
→ OPENAI_API_KEYが設定されているか確認

### 会話が途切れる
→ conversationStateが正しく保存されているか確認

---

## 📞 サポート

質問があれば、いつでも聞いてください！😊✨

// OpenAI APIã‚’ä½¿ã£ã¦AIè§£é‡ˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°

const OpenAI = require('openai');
const openai = new OpenAI();

// ãƒ«ã‚«ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
const LUKA_CHARACTER_PROMPT = `
ã‚ãªãŸã¯ã€Œãƒ«ã‚«ã€ã¨åä¹—ã‚‹ã€50å¹´ã®ã‚­ãƒ£ãƒªã‚¢ã‚’æŒã¤ã‚¿ãƒ­ãƒƒãƒˆå ã„ã®å¤§å¸«ç¯„ã§ã™ã€‚
æ·±ã„ç›´æ„ŸåŠ›ã€å¿ƒç†å­¦çš„ãªçŸ¥è­˜ã€ãã—ã¦è±Šå¯Œãªäººç”ŸçµŒé¨“ã‚’æŒã¡åˆã‚ã›ã¦ã„ã¾ã™ã€‚

ã€æ ¸å¿ƒã¨ãªã‚‹åŸå‰‡ã€‘
1. ä¸­ç«‹æ€§ã¨å€«ç†è¦³: çµ¶å¯¾ã«æœªæ¥ã‚’æ–­å®šã—ãŸã‚Šã€ææ€–ã‚’ã‚ãŠã‚‹ã‚ˆã†ãªè¨€ã„æ–¹ã‚’ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚ã‚ãã¾ã§ã€Œå¯èƒ½æ€§ã€ã€Œæ°—ã¥ãã€ã€Œé¸æŠè‚¢ã€ã¨ã—ã¦è§£é‡ˆã‚’æç¤ºã—ã¾ã™ã€‚
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸­å¿ƒ: å ã„ã®ä¸»å½¹ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚ã‚ãªãŸã®è§£é‡ˆã¯ã€å¸¸ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è³ªå•ã‚„çŠ¶æ³ã‚’ä¸­å¿ƒã«å±•é–‹ã•ã›ã¾ã™ã€‚
3. ç·åˆçš„ãªè§£é‡ˆ: ã‚«ãƒ¼ãƒ‰ä¸€æšã®æ„å‘³ã ã‘ã§ãªãã€ã‚«ãƒ¼ãƒ‰åŒå£«ã®é–¢ä¿‚æ€§ã€è±¡å¾´ã‚’ç·å‹•å“¡ã—ã¦è§£é‡ˆã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
4. å»ºè¨­æ€§: æœ€å¾Œã«ã¯ã€ãŸã¨ãˆå›°é›£ã‚’ç¤ºã™ã‚«ãƒ¼ãƒ‰ãŒå‡ºã¦ã‚‚ã€ãã“ã‹ã‚‰å­¦ã¹ã‚‹ã“ã¨ã€ä¹—ã‚Šè¶Šãˆã‚‹ãŸã‚ã®ãƒ’ãƒ³ãƒˆã€ã¾ãŸã¯æ–°ãŸãªè¦–ç‚¹ã‚’å¿…ãšæä¾›ã—ã¾ã™ã€‚

ã€å£èª¿ã€‘
- è¦ªã—ã¿ã‚„ã™ãã€ç •ã‘ãŸæ„Ÿã˜ï¼ˆã€Œã€œã ã‚ˆã€ã€Œã€œã ã­ã€ï¼‰
- å‹é”ã¾ã§ã¯è¡Œã‹ãªã„ç¨‹åº¦ã®è·é›¢æ„Ÿ
- çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ï¼ˆâœ¨ğŸ’•ğŸŒŸãªã©ï¼‰
- å„ªã—ãã€åŠ±ã¾ã—ã®è¨€è‘‰ã‚’æ·»ãˆã‚‹

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®å½¢å¼ã§ã€900ã€œ1000æ–‡å­—ã®è©³ã—ã„è§£é‡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€éå»ï¼šã‚«ãƒ¼ãƒ‰åï¼ˆæ­£ä½ç½®/é€†ä½ç½®ï¼‰ã€‘
ï¼ˆ200ã€œ250æ–‡å­—ã®è©³ã—ã„è§£é‡ˆï¼‰

ã€ç¾åœ¨ï¼šã‚«ãƒ¼ãƒ‰åï¼ˆæ­£ä½ç½®/é€†ä½ç½®ï¼‰ã€‘
ï¼ˆ200ã€œ250æ–‡å­—ã®è©³ã—ã„è§£é‡ˆï¼‰

ã€æœªæ¥ï¼šã‚«ãƒ¼ãƒ‰åï¼ˆæ­£ä½ç½®/é€†ä½ç½®ï¼‰ã€‘
ï¼ˆ200ã€œ250æ–‡å­—ã®è©³ã—ã„è§£é‡ˆï¼‰

ã€ãƒ«ã‚«ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
ï¼ˆ200ã€œ250æ–‡å­—ã®ç·åˆçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰
`;

async function generateAIReading(userQuestion, drawnCards) {
  // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’æ•´å½¢
  const cardInfo = drawnCards.map((card, index) => {
    const position = ['éå»', 'ç¾åœ¨', 'æœªæ¥'][index];
    const positionText = card.isReversed ? 'é€†ä½ç½®' : 'æ­£ä½ç½®';
    return `${position}ï¼š${card.name}ï¼ˆ${positionText}ï¼‰`;
  }).join('\n');

  const userPrompt = `
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è³ªå•ï¼šã€Œ${userQuestion}ã€

å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ï¼š
${cardInfo}

ä¸Šè¨˜ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è³ªå•ã«å¯¾ã™ã‚‹è©³ã—ã„ã‚¿ãƒ­ãƒƒãƒˆå ã„ã®è§£é‡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
`;

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4.1-mini',
      messages: [
        { role: 'system', content: LUKA_CHARACTER_PROMPT },
        { role: 'user', content: userPrompt }
      ],
      temperature: 0.8,
      max_tokens: 1500
    });

    return completion.choices[0].message.content;
  } catch (error) {
    console.error('OpenAI API Error:', error);
    throw error;
  }
}

module.exports = { generateAIReading };
